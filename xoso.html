<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Phân Tích Lô Đề</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px;
    }
    th {
      background: #eee;
      font-weight: bold;
    }
    .db {
      color: red;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      border: none;
      outline: none;
      text-align: center;
    }
    button {
      display: block;
      width: 100%;
      padding: 10px;
      font-size: 16px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    .result {
      background: #e9e9e9;
      padding: 10px;
      border-radius: 5px;
      margin-top: 15px;
    }
    .result h2 {
      margin-top: 0;
    }
    .note {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }
    /* Bảng kết quả, tần suất */
    .predict-table {
      margin-top: 15px;
      border: 1px solid #ccc;
      border-collapse: collapse;
      width: 100%;
    }
    .predict-table th, .predict-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .highlight {
      color: #d00;
      font-weight: bold;
    }
    .center {
      text-align: center;
    }
    /* Phần cài đặt tham số */
    .settings {
      margin-bottom: 20px;
      background: #fafafa;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
    }
    .settings label {
      display: inline-block;
      width: 160px;
      font-weight: bold;
    }
    .settings input[type="number"] {
      width: 80px;
      padding: 5px;
      margin-left: 5px;
    }
    .settings select {
      margin-left: 5px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h1>PHÂN TÍCH LÔ ĐỀ (Tất cả phương pháp, 10.000 lần mô phỏng)</h1>
  <div class="container">

    <!-- Phần cài đặt tham số -->
    <div class="settings">
      <p><strong>Cài đặt mô phỏng & phương pháp:</strong></p>
      <label for="alpha">Alpha (smoothing):</label>
      <input type="number" id="alpha" step="0.1" value="0.5" min="0" max="10">
      <br><br>
      <label for="temperature">Temperature (0.1 - 5):</label>
      <input type="number" id="temperature" step="0.1" value="0.7" min="0.1" max="5">
      <br><br>
      <label for="methodSelect">Phương pháp:</label>
      <select id="methodSelect">
        <option value="weighted">Weighted Random (Alpha + Temp)</option>
        <option value="nucleus">Nucleus Sampling (p)</option>
        <option value="topk">Top-K Sampling</option>
      </select>
      <br><br>
      <label for="nucleusP">Nucleus p (0.5 - 1.0):</label>
      <input type="number" id="nucleusP" step="0.1" value="0.9" min="0.5" max="1">
      <br><br>
      <label for="topK">Top-K (1 - 100):</label>
      <input type="number" id="topK" step="1" value="5" min="1" max="100">
      <p style="font-size: 0.9em; color: #444;">
        - <strong>Alpha</strong> (≥0): thêm vào tần suất để cặp số tần suất 0 vẫn có xác suất.  
        - <strong>Temperature</strong>: càng thấp, càng ưu tiên cặp tần suất cao.  
        - <strong>Nucleus p</strong>: xác suất tích lũy “nòng cốt” (0.5 - 1.0).  
        - <strong>Top-K</strong>: chỉ lấy K cặp có giá trị cao nhất (đã transform), rồi random trong đó.  
      </p>
    </div>

    <!-- Bảng nhập liệu (cập nhật G5=6 kết quả, G6=3, G7=4) -->
    <table>
      <!-- Đặc Biệt -->
      <tr>
        <th>ĐB</th>
        <td colspan="6">
          <input type="text" class="db" data-gi="DB" maxlength="6" placeholder="VD: 48130">
        </td>
      </tr>
      <!-- Giải 1 -->
      <tr>
        <th>1</th>
        <td colspan="6">
          <input type="text" data-gi="1" maxlength="5" placeholder="VD: 66421">
        </td>
      </tr>
      <!-- Giải 2 (2 kết quả) -->
      <tr>
        <th>2</th>
        <td><input type="text" data-gi="2" maxlength="5" placeholder="VD: 73844"></td>
        <td><input type="text" data-gi="2" maxlength="5" placeholder="VD: 41421"></td>
        <td colspan="4"></td>
      </tr>
      <!-- Giải 3 (6 kết quả) -->
      <tr>
        <th>3</th>
        <td><input type="text" data-gi="3" maxlength="5" placeholder="VD: 62423"></td>
        <td><input type="text" data-gi="3" maxlength="5" placeholder="VD: 46621"></td>
        <td><input type="text" data-gi="3" maxlength="5" placeholder="VD: 17961"></td>
        <td><input type="text" data-gi="3" maxlength="5" placeholder="VD: 19630"></td>
        <td><input type="text" data-gi="3" maxlength="5" placeholder="VD: 55272"></td>
        <td><input type="text" data-gi="3" maxlength="5" placeholder="VD: 97320"></td>
      </tr>
      <!-- Giải 4 (4 kết quả) -->
      <tr>
        <th>4</th>
        <td><input type="text" data-gi="4" maxlength="5" placeholder="VD: 9526"></td>
        <td><input type="text" data-gi="4" maxlength="5" placeholder="VD: 7565"></td>
        <td><input type="text" data-gi="4" maxlength="5" placeholder="VD: 2651"></td>
        <td><input type="text" data-gi="4" maxlength="5" placeholder="VD: 1660"></td>
        <td><input type="text" data-gi="4" maxlength="5" placeholder="VD: 2341"></td>
        <td><input type="text" data-gi="4" maxlength="5" placeholder="VD: 5125"></td>
        <td><input type="text" data-gi="4" maxlength="5" placeholder="VD: 5211"></td>
      </tr>
      <!-- Giải 5 (6 kết quả) -->
      <tr>
        <th>5</th>
        <td><input type="text" data-gi="5" maxlength="5" placeholder="VD: 9130"></td>
        <td><input type="text" data-gi="5" maxlength="5" placeholder="VD: 1718"></td>
        <td><input type="text" data-gi="5" maxlength="5" placeholder="VD: 4336"></td>
        <td><input type="text" data-gi="5" maxlength="5" placeholder="VD: 9999"></td>
        <td><input type="text" data-gi="5" maxlength="5" placeholder="VD: 8888"></td>
        <td><input type="text" data-gi="5" maxlength="5" placeholder="VD: 7777"></td>
      </tr>
      <!-- Giải 6 (3 kết quả, mỗi kết quả 3 chữ số) -->
      <tr>
        <th>6</th>
        <td><input type="text" data-gi="6" maxlength="4 " placeholder="VD: 123"></td>
        <td><input type="text" data-gi="6" maxlength="4" placeholder="VD: 456"></td>
        <td><input type="text" data-gi="6" maxlength="4" placeholder="VD: 789"></td>
        <td colspan="3"></td>
      </tr>
      <!-- Giải 7 (4 kết quả, mỗi kết quả 2 chữ số) -->
      <tr>
        <th>7</th>
        <td><input type="text" data-gi="7" maxlength="3" placeholder="VD: 122"></td>
        <td><input type="text" data-gi="7" maxlength="3" placeholder="VD: 343"></td>
        <td><input type="text" data-gi="7" maxlength="3" placeholder="VD: 456"></td>
        <td><input type="text" data-gi="7" maxlength="3" placeholder="VD: 758"></td>
        <td colspan="2"></td>
      </tr>
      <tr>
        <th>8</th>
        <td><input type="text" data-gi="7" maxlength="2" placeholder="VD: 12"></td>
        <td colspan="2"></td>
      </tr>
    </table>

    <button onclick="analyze()">Phân tích</button>
    
    <!-- Hiển thị kết quả phân tích -->
    <div class="result" id="resultArea" style="display: none;">
      <h2>Kết quả Phân Tích</h2>
      <div id="resultContent"></div>
    </div>
    <div class="note">
      <strong>Lưu ý:</strong> Mọi kết quả chỉ mang tính tham khảo, không đảm bảo chính xác 100%.
    </div>
  </div>

  <script>
    //=== 1) LẤY CHỮ SỐ CUỐI THEO GIẢI ===
    function getLastDigits(value, gi) {
      if (gi === '6') {
        // G6 có 3 chữ số
        return value.slice(-3).padStart(3, '0');
      } else if (gi === '7') {
        // G7 có 2 chữ số
        return value.slice(-2).padStart(2, '0');
      } else {
        // Mặc định lấy 2 chữ số cuối
        return value.slice(-2).padStart(2, '0');
      }
    }

    //=== 2) Weighted Random (Alpha + Temperature) ===
    function createWeightedDistribution(freqMap, alpha, temperature) {
      let weightedArray = [];
      for (let [digits, count] of Object.entries(freqMap)) {
        let val = count + alpha;
        val = Math.pow(val, 1 / temperature);
        weightedArray.push([digits, val]);
      }
      // Nếu rỗng => tạo 00..99
      if (weightedArray.length === 0) {
        for (let i = 0; i < 100; i++) {
          let d = i.toString().padStart(2, '0');
          let v = Math.pow(alpha, 1/temperature);
          weightedArray.push([d, v]);
        }
      }
      // Tính tổng
      let sumVal = weightedArray.reduce((s, x) => s + x[1], 0);
      // Tạo dist
      let dist = {};
      weightedArray.forEach(([digits, val]) => {
        dist[digits] = val / sumVal;
      });
      return dist;
    }

    function randomFromDist(dist) {
      let rand = Math.random();
      let cumulative = 0;
      for (let [digits, p] of Object.entries(dist)) {
        cumulative += p;
        if (rand < cumulative) {
          return digits;
        }
      }
      return Object.keys(dist)[0];
    }

    //=== 3) Nucleus Sampling (p) ===
    function createNucleusDistribution(freqMap, alpha, temperature, nucleusP) {
      // Tạo weightedArray (chưa chuẩn hoá)
      let weightedArray = [];
      for (let [digits, count] of Object.entries(freqMap)) {
        let val = count + alpha;
        val = Math.pow(val, 1 / temperature);
        weightedArray.push([digits, val]);
      }
      if (weightedArray.length === 0) {
        for (let i = 0; i < 100; i++) {
          let d = i.toString().padStart(2, '0');
          let v = Math.pow(alpha, 1/temperature);
          weightedArray.push([d, v]);
        }
      }
      // Sort giảm dần
      weightedArray.sort((a,b) => b[1] - a[1]);

      // Tổng
      let totalVal = weightedArray.reduce((s, x) => s + x[1], 0);

      // Tính p theo tỉ lệ val/totalVal, cộng dồn đến nucleusP
      let subList = [];
      let sumSub = 0;
      for (let [digits, val] of weightedArray) {
        let p = val / totalVal;
        subList.push([digits, p]);
        sumSub += p;
        if (sumSub >= nucleusP) break;
      }
      // Chuẩn hoá subList => dist
      let dist = {};
      for (let [digits, p] of subList) {
        dist[digits] = p / sumSub;
      }
      return dist;
    }

    function randomFromNucleus(dist) {
      let rand = Math.random();
      let cumulative = 0;
      for (let [digits, p] of Object.entries(dist)) {
        cumulative += p;
        if (rand < cumulative) {
          return digits;
        }
      }
      return Object.keys(dist)[0];
    }

    //=== 4) Top-K Sampling ===
    function createTopKDistribution(freqMap, alpha, temperature, topK) {
      // Tương tự Weighted, nhưng ta sort & lấy K phần tử
      let weightedArray = [];
      for (let [digits, count] of Object.entries(freqMap)) {
        let val = count + alpha;
        val = Math.pow(val, 1 / temperature);
        weightedArray.push([digits, val]);
      }
      if (weightedArray.length === 0) {
        for (let i = 0; i < 100; i++) {
          let d = i.toString().padStart(2, '0');
          let v = Math.pow(alpha, 1/temperature);
          weightedArray.push([d, v]);
        }
      }
      // Sort giảm dần
      weightedArray.sort((a,b) => b[1] - a[1]);

      // Lấy top K
      let subList = weightedArray.slice(0, topK);

      // Tính tổng
      let sumVal = subList.reduce((s, x) => s + x[1], 0);

      // Tạo dist
      let dist = {};
      subList.forEach(([digits, val]) => {
        dist[digits] = val / sumVal;
      });
      return dist;
    }

    function randomFromTopK(dist) {
      // Giống randomFromDist
      let rand = Math.random();
      let cumulative = 0;
      for (let [digits, p] of Object.entries(dist)) {
        cumulative += p;
        if (rand < cumulative) {
          return digits;
        }
      }
      return Object.keys(dist)[0];
    }

    //=== 5) Mô phỏng n lần từ 1 trong 3 phương pháp ===
    function runSimulation(n, dist, method) {
      let simFreqMap = {};
      for (let i = 0; i < n; i++) {
        let digits;
        if (method === 'weighted') {
          digits = randomFromDist(dist);
        } else if (method === 'nucleus') {
          digits = randomFromNucleus(dist);
        } else {
          // topk
          digits = randomFromTopK(dist);
        }
        if (!simFreqMap[digits]) simFreqMap[digits] = 0;
        simFreqMap[digits]++;
      }
      return simFreqMap;
    }

    //=== 6) HÀM CHÍNH: analyze() ===
    function analyze() {
      // Lấy tham số
      const alpha = parseFloat(document.getElementById('alpha').value) || 0;
      const temperature = parseFloat(document.getElementById('temperature').value) || 1;
      const method = document.getElementById('methodSelect').value; 
      const nucleusP = parseFloat(document.getElementById('nucleusP').value) || 0.9;
      const topK = parseInt(document.getElementById('topK').value) || 5;

      // Thu thập dữ liệu
      const inputs = document.querySelectorAll('table input[type="text"]');
      let allDigitsArr = [];
      let userValues = [];

      inputs.forEach(input => {
        let val = input.value.trim();
        let gi = input.getAttribute('data-gi');
        userValues.push(val);
        if (val !== '' && !isNaN(val)) {
          let lastX = getLastDigits(val, gi);
          allDigitsArr.push(lastX);
        }
      });

      // freqMap
      let freqMap = {};
      allDigitsArr.forEach(d => {
        if (!freqMap[d]) freqMap[d] = 0;
        freqMap[d]++;
      });

      // Tạo distribution
      let dist;
      if (method === 'weighted') {
        dist = createWeightedDistribution(freqMap, alpha, temperature);
      } else if (method === 'nucleus') {
        dist = createNucleusDistribution(freqMap, alpha, temperature, nucleusP);
      } else {
        dist = createTopKDistribution(freqMap, alpha, temperature, topK);
      }

      // Mô phỏng 10.000 lần
      let simulationCount = 10000;
      let simFreqMap = runSimulation(simulationCount, dist, method);

      // Sắp xếp
      let sortedSim = Object.entries(simFreqMap).sort((a,b) => b[1] - a[1]);

      // Top 5
      let top5HTML = '';
      sortedSim.slice(0,5).forEach(([digits, count], idx) => {
        top5HTML += `
          <tr>
            <td>${idx+1}</td>
            <td><strong>${digits}</strong></td>
            <td>${count}</td>
            <td>${((count / simulationCount)*100).toFixed(2)}%</td>
          </tr>
        `;
      });

      // So sánh với dữ liệu người dùng
      let userSet = new Set(allDigitsArr);
      let matchCount = 0;
      sortedSim.slice(0,5).forEach(([digits]) => {
        if (userSet.has(digits)) {
          matchCount++;
        }
      });
      let compareMsg = `Trong top 5 mô phỏng, có <strong>${matchCount}</strong> kết quả trùng với dữ liệu bạn nhập.`;

      // Dự đoán cuối cùng cho từng ô
      let predictions = userValues.map(val => {
        if (method === 'weighted') {
          return randomFromDist(dist);
        } else if (method === 'nucleus') {
          return randomFromNucleus(dist);
        } else {
          return randomFromTopK(dist);
        }
      });

      // Tạo bảng hiển thị dự đoán
      let predictTableHTML = `
        <table class="predict-table">
          <tr>
            <th>Ô</th>
            <th>Giá trị nhập</th>
            <th>Dự đoán</th>
          </tr>
      `;
      predictions.forEach((digits, idx) => {
        predictTableHTML += `
          <tr>
            <td>${idx+1}</td>
            <td>${userValues[idx] || '<em>Trống</em>'}</td>
            <td class="highlight">${digits}</td>
          </tr>
        `;
      });
      predictTableHTML += `</table>`;

      // Kết quả HTML
      let resultHTML = `
        <p><strong>Mô phỏng ${simulationCount} lần (${method}):</strong></p>
        <table class="predict-table">
          <tr>
            <th>Hạng</th>
            <th>Chuỗi</th>
            <th>Số lần</th>
            <th>Tỷ lệ</th>
          </tr>
          ${top5HTML || '<tr><td colspan="4">Không có dữ liệu</td></tr>'}
        </table>
        <p>${compareMsg}</p>
        <h3>Dự đoán cho từng ô:</h3>
        ${predictTableHTML}
      `;

      document.getElementById('resultContent').innerHTML = resultHTML;
      document.getElementById('resultArea').style.display = 'block';
    }
  </script>
</body>
</html>
